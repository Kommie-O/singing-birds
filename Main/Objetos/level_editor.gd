extends Node2D

# Set this constant before game start
const in_edit_mode: bool = false
var current_level_name = "LECHUZA_TANGUERA"

# Time it takes for falling key to reach critical spot
var fk_fall_time: float = 2.2
var fk_output_arr = [[], [], [], []]

var level_info = {
	"LECHUZA_TANGUERA" = {
		"fk_times": "[[6.53829908370972
, 8.21288013458252
, 10.1114511489868
, 14.9325399398804
, 18.4843311309814
, 20.1375961303711
, 20.9588661193848
, 24.9373245239258
, 25.1293201446533
, 29.2357597351074
, 31.6356468200684
, 31.8596363067627
, 34.9634704589844
, 38.2806129455566
, 39.912540435791
, 42.2377548217773
, 44.3389587402344
, 47.6561241149902
, 51.2292747497559
, 51.6239242553711
, 51.8158950805664
, 54.3437652587891
, 54.9837417602539
, 55.1757125854492
, 55.613037109375
, 58.546215057373
, 62.3326759338379
, 64.988525390625
, 68.3056945800781
, 68.5190277099609
, 71.0362167358398
, 76.9025650024414
, 77.1692276000977
, 81.0623550415039
, 84.3795013427734
, 86.054084777832
, 87.6859893798828
, 91.7391128540039
, 91.9311141967773
, 93.6056900024414],[4.27709770202637
, 6.9862813949585
, 9.51414966583252
, 10.527437210083
, 13.2366209030151
, 14.2925624847412
, 15.1458501815796
, 17.6097278594971
, 18.2710208892822
, 19.9136047363281
, 20.5642395019531
, 21.5668487548828
, 24.2653732299805
, 25.5453052520752
, 28.2438316345215
, 30.5263710021973
, 32.2436065673828
, 33.9288444519043
, 35.6141052246094
, 37.885986328125
, 38.4939460754395
, 39.2832412719727
, 40.136531829834
, 42.6643981933594
, 44.9682769775391
, 47.261474609375
, 48.2427673339844
, 49.9280052185059
, 52.4665298461914
, 52.6905212402344
, 56.0290031433105
, 56.2316780090332
, 56.6369857788086
, 56.8289794921875
, 59.3568267822266
, 61.9593658447266
, 63.9539222717285
, 66.7911148071289
, 68.9563293457031
, 71.7294998168945
, 74.3853759765625
, 76.7105865478516
, 77.5105438232422
, 79.9850769042969
, 81.6809768676758
, 82.3316116333008
, 83.9635391235352
, 85.2541275024414
, 86.9393615722656
, 88.3153076171875
, 90.0538787841797
, 90.3098602294922
, 92.3577575683594],[6.34632635116577
, 7.60492086410522
, 9.70614528656006
, 10.3460998535156
, 10.9860773086548
, 11.8393650054932
, 13.8445806503296
, 16.7777557373047
, 18.4950122833252
, 20.1375961303711
, 22.4094562530518
, 23.8600444793701
, 26.8252372741699
, 27.6038551330566
, 29.929069519043
, 30.9636726379395
, 32.6382522583008
, 34.3768272399902
, 36.0300674438477
, 36.2114067077637
, 36.830020904541
, 41.213809967041
, 41.8431053161621
, 43.485668182373
, 45.5868949890137
, 45.9922218322754
, 46.184196472168
, 48.8934020996094
, 49.3093643188477
, 53.3198204040527
, 58.546215057373
, 60.3274612426758
, 61.0847396850586
, 63.3352851867676
, 65.212516784668
, 67.6657333374023
, 70.0122680664063
, 70.6309051513672
, 73.6067352294922
, 75.6226272583008
, 78.3531494140625
, 80.6357116699219
, 82.7262573242188
, 83.590202331543
, 86.0754165649414
, 87.3020172119141
, 88.9659194946289
, 91.0778198242188
, 93.6056900024414],[6.11165523529053
, 6.76229047775269
, 7.18893432617188
, 8.43687057495117
, 9.90879821777344
, 10.7940816879272
, 11.6260318756104
, 13.6312694549561
, 14.0792512893677
, 16.53244972229
, 17.1937408447266
, 18.2923583984375
, 19.8922672271729
, 20.5429019927979
, 21.7908382415771
, 22.6441268920898
, 23.5400676727295
, 25.9826068878174
, 27.2092056274414
, 28.4891376495361
, 30.1637191772461
, 32.3929252624512
, 33.5448760986328
, 35.1874618530273
, 36.627368927002
, 38.8885955810547
, 39.5285491943359
, 41.640453338623
, 43.2936973571777
, 45.1709289550781
, 46.6321754455566
, 46.8241729736328
, 48.4560775756836
, 49.5333557128906
, 50.1839904785156
, 52.8931732177734
, 53.5224723815918
, 57.6822662353516
, 59.3568267822266
, 60.6900901794434
, 61.2873916625977
, 62.961971282959
, 63.5379371643066
, 64.5298843383789
, 67.2924041748047
, 69.5536270141602
, 70.2256011962891
, 71.9214935302734
, 73.9800643920898
, 74.9826736450195
, 75.2066650390625
, 76.3265991210938
, 77.7131958007813
, 78.5878219604492
, 80.2303848266602
, 81.9049682617188
, 83.3555526733398
, 85.2541275024414
, 86.9287109375
, 88.5606155395508
, 89.3712463378906
, 90.6831741333008
, 92.7417221069336]]",
		"music": load("res://Main/Musica/Music_Tango_150BPM_005.wav")
	}
}

# Called when the node enters the scene tree for the first time.
func _ready():
	
	$Musica.stream = level_info.get(current_level_name).get("music")
	$Musica.play()
	
	if in_edit_mode:
		Senales.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "button_A"
				1:
					button_name = "button_S"
				2:
					button_name = "button_D"
				3:
					button_name = "button_F"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
			
			counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	print(str(array_num) + " " + str($Musica.get_playback_position()))
	fk_output_arr[array_num].append($Musica.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Senales.CreateFallingKey.emit(button_name)


func _on_music_player_finished():
	print(fk_output_arr)
